{% extends 'admin/base.html' %}

{% block title %}동영상 관리{% endblock %}

{% block content %}
    <h2 class="mb-4">동영상 관리</h2>
    
    <!-- 새 동영상 추가 폼 -->
    <div class="card mb-4">
        <div class="card-header">
            <h4 class="mb-0">새 동영상 추가</h4>
        </div>
        <div class="card-body">
            <form id="video-form">
                <div class="row">
                    <div class="col-md-6">
                        <label for="title" class="form-label">동영상 제목</label>
                        <input type="text" class="form-control" id="title" name="title" required>
                    </div>
                    <div class="col-md-6">
                        <label for="video_url" class="form-label">유튜브 URL</label>
                        <input type="url" class="form-control" id="video_url" name="video_url" 
                               placeholder="https://www.youtube.com/watch?v=..." required>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <label for="description" class="form-label">설명</label>
                        <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                    </div>
                </div>
                <div class="mt-3">
                    <button type="submit" class="btn btn-primary">동영상 추가</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 동영상 목록 -->
    <div class="card">
        <div class="card-header">
            <h4 class="mb-0">동영상 목록</h4>
        </div>
        <div class="card-body">
            {% if videos %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>제목</th>
                                <th>설명</th>
                                <th>미리보기</th>
                                <th>통계</th>
                                <th>생성일</th>
                                <th>액션</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for video in videos %}
                            <tr>
                                <td>
                                    <strong>{{ video[1] }}</strong>
                                </td>
                                <td>
                                    <div class="text-truncate" style="max-width: 200px;" title="{{ video[3] or '설명 없음' }}">
                                        {{ video[3] or '설명 없음' }}
                                    </div>
                                </td>
                                <td>
                                    <div class="ratio ratio-16x9" style="width: 150px;">
                                        <iframe src="{{ video[2] }}" 
                                                title="{{ video[1] }}"
                                                allowfullscreen></iframe>
                                    </div>
                                </td>
                                <td>
                                    <div class="stats">
                                        <small class="text-muted">
                                            <div><i class="fas fa-eye"></i> 총 시청: {{ video_stats[loop.index0].stats.total_viewers }}회</div>
                                            <div><i class="fas fa-check-circle"></i> 완료: {{ video_stats[loop.index0].stats.completed_viewers }}회</div>
                                            <div><i class="fas fa-percentage"></i> 완료율: {{ "%.1f"|format(video_stats[loop.index0].stats.completion_rate) }}%</div>
                                        </small>
                                    </div>
                                </td>
                                <td>
                                    <small class="text-muted">{{ video[4] }}</small>
                                </td>
                                <td>
                                    <div class="d-flex gap-1">
                                        <button class="btn btn-sm btn-outline-primary" 
                                                onclick="editVideo({{ video[0] }}, '{{ video[1] }}', '{{ video[2] }}', '{{ video[3] or '' }}')"
                                                title="동영상 수정">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" 
                                                onclick="deleteVideo({{ video[0] }}, '{{ video[1] }}')"
                                                title="동영상 삭제">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-video fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">등록된 동영상이 없습니다</h5>
                    <p class="text-muted">새 동영상을 추가해보세요.</p>
                </div>
            {% endif %}
        </div>
    </div>
    
    <!-- 수정 모달 -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">동영상 수정</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="edit-form">
                        <input type="hidden" id="edit-video-id">
                        <div class="mb-3">
                            <label for="edit-title" class="form-label">제목</label>
                            <input type="text" class="form-control" id="edit-title" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-video-url" class="form-label">유튜브 URL</label>
                            <input type="url" class="form-control" id="edit-video-url" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-description" class="form-label">설명</label>
                            <textarea class="form-control" id="edit-description" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-primary" onclick="saveEdit()">저장</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
// 동영상 추가
document.getElementById('video-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    fetch('{{ url_for("admin.create_video") }}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('동영상이 성공적으로 추가되었습니다.');
            location.reload();
        } else {
            alert('오류: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('오류가 발생했습니다.');
    });
});

// 동영상 수정
function editVideo(id, title, url, description) {
    document.getElementById('edit-video-id').value = id;
    document.getElementById('edit-title').value = title;
    document.getElementById('edit-video-url').value = url;
    document.getElementById('edit-description').value = description;
    
    new bootstrap.Modal(document.getElementById('editModal')).show();
}

function saveEdit() {
    const id = document.getElementById('edit-video-id').value;
    const title = document.getElementById('edit-title').value;
    const url = document.getElementById('edit-video-url').value;
    const description = document.getElementById('edit-description').value;
    
    const formData = new FormData();
    formData.append('title', title);
    formData.append('video_url', url);
    formData.append('description', description);
    
    fetch(`/admin/videos/update/${id}`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('동영상이 성공적으로 수정되었습니다.');
            location.reload();
        } else {
            alert('오류: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('오류가 발생했습니다.');
    });
}

// 동영상 삭제
function deleteVideo(id, title) {
    if (confirm(`"${title}" 동영상을 삭제하시겠습니까?`)) {
        fetch(`/admin/videos/delete/${id}`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('동영상이 성공적으로 삭제되었습니다.');
                location.reload();
            } else {
                alert('오류: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('오류가 발생했습니다.');
        });
    }
}
</script>
{% endblock %}
