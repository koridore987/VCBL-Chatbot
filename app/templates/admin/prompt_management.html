{% extends 'admin/base.html' %}

{% block title %}프롬프트 관리{% endblock %}

{% block content %}
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>프롬프트 관리</h2>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createModal">
                + 새 챗봇 타입 추가
            </button>
        </div>
        
        {% if chatbot_types %}
            {% for chatbot in chatbot_types %}
            <div class="prompt-card">
                <div class="row">
                    <div class="col-md-8">
                        <h4>{{ chatbot[1] }}</h4>
                        <p class="text-muted">{{ chatbot[2] }}</p>
                        <div class="prompt-preview mb-3">{{ chatbot[3] }}</div>
                        <small class="text-muted">
                            생성: {{ chatbot[4][:19] if chatbot[4] else 'N/A' }} | 
                            수정: {{ chatbot[5][:19] if chatbot[5] else 'N/A' }}
                        </small>
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="mb-3">
                            <span class="badge badge-usage">사용자 {{ usage_counts.get(chatbot[0], 0) }}명</span>
                        </div>
                        <button class="btn btn-warning btn-sm mb-2" 
                                onclick="editChatbot({{ chatbot[0] }}, '{{ chatbot[1] }}', '{{ chatbot[2] }}', `{{ chatbot[3] }}`)">
                            수정
                        </button>
                        <button class="btn btn-danger btn-sm mb-2" 
                                onclick="deleteChatbot({{ chatbot[0] }}, '{{ chatbot[1] }}', {{ usage_counts.get(chatbot[0], 0) }})">
                            삭제
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <p class="text-muted">등록된 챗봇 타입이 없습니다.</p>
        {% endif %}
    </div>
    
    <!-- 생성 모달 -->
    <div class="modal fade" id="createModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">새 챗봇 타입 추가</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" action="{{ url_for('admin.create_chatbot_type') }}">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">챗봇 타입 이름</label>
                            <input type="text" class="form-control" name="name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">설명</label>
                            <input type="text" class="form-control" name="description" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">시스템 프롬프트</label>
                            <textarea class="form-control" name="system_prompt" rows="8" required></textarea>
                            <small class="text-muted">챗봇의 역할과 행동 방식을 정의하는 프롬프트를 입력하세요.</small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                        <button type="submit" class="btn btn-primary">생성</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- 수정 모달 -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">챗봇 타입 수정</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="editForm" method="POST">
                    <div class="modal-body">
                        <div class="alert alert-warning">
                            <strong>⚠️ 주의:</strong> 프롬프트를 수정하면 이 챗봇 타입을 사용하는 모든 사용자의 대화 방식이 변경됩니다.
                        </div>
                        <div class="mb-3">
                            <label class="form-label">챗봇 타입 이름</label>
                            <input type="text" class="form-control" id="edit_name" name="name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">설명</label>
                            <input type="text" class="form-control" id="edit_description" name="description" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">시스템 프롬프트</label>
                            <textarea class="form-control" id="edit_system_prompt" name="system_prompt" rows="8" required></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                        <button type="button" class="btn btn-warning" onclick="confirmEdit()">변경 확인</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- 변경 확인 모달 -->
    <div class="modal fade" id="confirmModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title">⚠️ 변경 확인</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p><strong>정말로 프롬프트를 변경하시겠습니까?</strong></p>
                    <p class="text-muted">이 변경사항은 즉시 적용되며, 이 챗봇 타입을 사용하는 모든 사용자에게 영향을 미칩니다.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-warning" onclick="submitEdit()">확인하고 변경</button>
                </div>
            </div>
        </div>
{% endblock %}

{% block extra_js %}
    <script>
        let currentEditId = null;
        
        function editChatbot(id, name, description, prompt) {
            currentEditId = id;
            document.getElementById('edit_name').value = name;
            document.getElementById('edit_description').value = description;
            document.getElementById('edit_system_prompt').value = prompt;
            new bootstrap.Modal(document.getElementById('editModal')).show();
        }
        
        function confirmEdit() {
            bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
            new bootstrap.Modal(document.getElementById('confirmModal')).show();
        }
        
        function submitEdit() {
            const form = document.getElementById('editForm');
            form.action = `/admin/update_chatbot_type/${currentEditId}`;
            form.submit();
        }
        
        function deleteChatbot(id, name, usageCount) {
            if (usageCount > 0) {
                alert(`이 챗봇 타입은 현재 ${usageCount}명의 사용자가 사용 중이므로 삭제할 수 없습니다.`);
                return;
            }
            
            if (confirm(`정말로 '${name}' 챗봇 타입을 삭제하시겠습니까?`)) {
                fetch(`/admin/delete_chatbot_type/${id}`, {
                    method: 'POST'
                }).then(response => {
                    if (response.ok) {
                        location.reload();
                    } else {
                        alert('삭제에 실패했습니다.');
                    }
                });
            }
        }
    </script>
{% endblock %}

