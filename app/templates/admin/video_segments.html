{% extends "admin/base.html" %}

{% block title %}비디오 구간 관리{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-1">비디오 구간 관리</h2>
                    <p class="text-muted mb-0">{{ video[1] }}</p>
                </div>
                <div>
                    <a href="{{ url_for('admin.video_management') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> 동영상 목록으로
                    </a>
                </div>
            </div>

            <!-- 구간 추가 폼 -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-plus-circle"></i> 새 구간 추가
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('admin.create_video_segment', video_id=video[0]) }}">
                        <div class="row">
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label for="segment_index">구간 번호</label>
                                    <input type="number" class="form-control" id="segment_index" name="segment_index" 
                                           value="{{ segments|length + 1 if segments else 1 }}" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="segment_name">구간 이름</label>
                                    <input type="text" class="form-control" id="segment_name" name="segment_name" 
                                           placeholder="예: 도입, 핵심개념, 예제" required>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label for="start_time">시작 시간 (초)</label>
                                    <input type="number" class="form-control" id="start_time" name="start_time" 
                                           step="0.1" placeholder="0" required>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label for="end_time">종료 시간 (초)</label>
                                    <input type="number" class="form-control" id="end_time" name="end_time" 
                                           step="0.1" placeholder="60" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="description">설명 (선택사항)</label>
                                    <input type="text" class="form-control" id="description" name="description" 
                                           placeholder="구간에 대한 설명">
                                </div>
                            </div>
                        </div>
                        <div class="text-end">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-plus"></i> 구간 추가
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- 구간 목록 -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-list"></i> 구간 목록 ({{ segments|length }}개)
                    </h5>
                </div>
                <div class="card-body">
                    {% if segments %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>구간 번호</th>
                                        <th>구간 이름</th>
                                        <th>시작 시간</th>
                                        <th>종료 시간</th>
                                        <th>길이</th>
                                        <th>설명</th>
                                        <th>작업</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for segment in segments %}
                                    <tr>
                                        <td>
                                            <span class="badge bg-primary">{{ segment[1] }}</span>
                                        </td>
                                        <td>
                                            <strong>{{ segment[2] }}</strong>
                                        </td>
                                        <td>
                                            <span class="text-muted">{{ "%.1f"|format(segment[3]) }}초</span>
                                        </td>
                                        <td>
                                            <span class="text-muted">{{ "%.1f"|format(segment[4]) }}초</span>
                                        </td>
                                        <td>
                                            <span class="badge bg-info">{{ "%.1f"|format(segment[4] - segment[3]) }}초</span>
                                        </td>
                                        <td>
                                            <small class="text-muted">{{ segment[5] or '-' }}</small>
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <button type="button" class="btn btn-outline-primary btn-sm" 
                                                        onclick="editSegment({{ segment[0] }}, '{{ segment[2] }}', {{ segment[3] }}, {{ segment[4] }}, '{{ segment[5] or '' }}')">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <form method="POST" action="{{ url_for('admin.delete_video_segment', segment_id=segment[0]) }}" 
                                                      style="display: inline;" onsubmit="return confirm('정말로 이 구간을 삭제하시겠습니까?')">
                                                    <button type="submit" class="btn btn-outline-danger btn-sm">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </form>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-video fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">등록된 구간이 없습니다</h5>
                            <p class="text-muted">위의 폼을 사용하여 첫 번째 구간을 추가해보세요.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 구간 수정 모달 -->
<div class="modal fade" id="editSegmentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">구간 수정</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" id="editSegmentForm">
                <div class="modal-body">
                    <div class="form-group mb-3">
                        <label for="edit_segment_name">구간 이름</label>
                        <input type="text" class="form-control" id="edit_segment_name" name="segment_name" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="edit_start_time">시작 시간 (초)</label>
                                <input type="number" class="form-control" id="edit_start_time" name="start_time" 
                                       step="0.1" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="edit_end_time">종료 시간 (초)</label>
                                <input type="number" class="form-control" id="edit_end_time" name="end_time" 
                                       step="0.1" required>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="edit_description">설명</label>
                        <input type="text" class="form-control" id="edit_description" name="description">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="submit" class="btn btn-primary">수정</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function editSegment(segmentId, name, startTime, endTime, description) {
    document.getElementById('editSegmentForm').action = '{{ url_for("admin.update_video_segment", segment_id=0) }}'.replace('0', segmentId);
    document.getElementById('edit_segment_name').value = name;
    document.getElementById('edit_start_time').value = startTime;
    document.getElementById('edit_end_time').value = endTime;
    document.getElementById('edit_description').value = description || '';
    
    new bootstrap.Modal(document.getElementById('editSegmentModal')).show();
}

// 시간 입력 도우미
document.addEventListener('DOMContentLoaded', function() {
    // 시작 시간과 종료 시간 입력 시 자동 계산
    const startTimeInput = document.getElementById('start_time');
    const endTimeInput = document.getElementById('end_time');
    
    if (startTimeInput && endTimeInput) {
        startTimeInput.addEventListener('input', function() {
            const startTime = parseFloat(this.value) || 0;
            const endTime = parseFloat(endTimeInput.value) || 0;
            
            if (endTime <= startTime && endTime > 0) {
                endTimeInput.value = startTime + 60; // 기본 1분 길이
            }
        });
    }
});
</script>
{% endblock %}
